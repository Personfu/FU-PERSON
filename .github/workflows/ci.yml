name: CI - Validate & Test

on:
  push:
    branches: [main]
    paths:
      - 'core/**'
      - 'payloads/**'
      - 'scripts/**'
      - 'requirements.txt'
  pull_request:
    branches: [main]

jobs:
  validate-python:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install core dependencies
        run: pip install requests beautifulsoup4 lxml dnspython colorama fpdf2 duckduckgo-search

      - name: Syntax check all Python modules
        run: |
          echo "=== Compiling all .py files ==="
          FAIL=0
          for f in $(find core/ payloads/ scripts/ -name '*.py' -type f); do
            if python -m py_compile "$f" 2>&1; then
              echo "  OK: $f"
            else
              echo "  FAIL: $f"
              FAIL=1
            fi
          done
          if [ "$FAIL" -eq 1 ]; then
            echo "::error::One or more Python files failed syntax check"
            exit 1
          fi
          echo "All Python files passed syntax validation"

      - name: Import check core modules
        run: |
          echo "=== Verifying core module imports ==="
          cd core
          python -c "
          import importlib, sys
          modules = [
              'pentest_suite', 'osint_recon_suite', 'galaxy_recon_suite',
              'people_finder', 'repo_collector', 'list_consolidator',
              'consolidated_lists', 'network_sniffer', 'tunnel_proxy',
              'exploit_dev', 'cms_scanner', 'voip_scanner',
              'stress_tester', 'ids_evasion', 'cve_engine',
              'cve_monitor', 'quantum_crypto', 'crypto_audit',
          ]
          failed = []
          for mod in modules:
              try:
                  importlib.import_module(mod)
                  print(f'  OK: {mod}')
              except Exception as e:
                  print(f'  FAIL: {mod} -> {e}')
                  failed.append(mod)
          if failed:
              print(f'::error::{len(failed)} modules failed import: {failed}')
              sys.exit(1)
          print(f'All {len(modules)} core modules imported successfully')
          "

  validate-powershell:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Syntax check all PowerShell scripts
        shell: pwsh
        run: |
          $errors = @()
          Get-ChildItem -Recurse -Filter *.ps1 | ForEach-Object {
            $tokens = $null
            $parseErrors = $null
            [System.Management.Automation.PSParser]::Tokenize(
              (Get-Content $_.FullName -Raw -Encoding UTF8), [ref]$parseErrors
            ) | Out-Null
            if ($parseErrors.Count -gt 0) {
              $errors += $_.FullName
              Write-Host "  FAIL: $($_.FullName) ($($parseErrors.Count) errors)"
              $parseErrors | ForEach-Object { Write-Host "    -> $($_.Message)" }
            } else {
              Write-Host "  OK: $($_.FullName)"
            }
          }
          if ($errors.Count -gt 0) {
            Write-Error "$($errors.Count) PowerShell files have syntax errors"
            exit 1
          }
          Write-Host "All PowerShell scripts passed syntax validation"

  integrity-check:
    runs-on: ubuntu-latest
    needs: [validate-python]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Verify file integrity
        run: |
          if [ -f CHECKSUMS.sha256 ]; then
            python scripts/verify_integrity.py verify
          else
            echo "No CHECKSUMS.sha256 found -- generating baseline"
            python scripts/verify_integrity.py generate
          fi
